// Diego Dorta <diego.dorta@nxp.com>
// Vanessa Maegima <vanessa.maegima@nxp.com>
[[mnist]]
== Handwritten Digits using MNIST Dataset

This {EIQ_DIGITS_COMMUNITY}[application] provides a comparison of a {CAFFE}[Caffe] and {TENSORFLOW}[TensorFlow]
models for _Handwritten Digit Recognition_. The data set used is called `MNIST` from {MNIST}[Yann Lecun].

Follow a sample of this dataset:

.MNIST data set
image::chapters/media/mnist-data.png[alt=MNIST Draw, pdfwidth=50%, title-align=center, align=center]

[IMPORTANT]
====
These images are processed in 28x28 resolution pixels.
====

[TIP]
====
The `MNIST` is a large database of handwritten digits commonly used for training
various image processing systems.
====

[[prepare_mnist]]
=== Compiling the Handwritten Digits Application

. Compile the {MNIST_DEMO_LINK}[MNIST] application on _host GNU/Linux PC_:
+
_On Host GNU/Linux PC Terminal execute the following commands:_
+
[%autofit]
----
$ cd ~/Desktop/files/mnist // <1>
$ source /opt/fsl-imx-internal-xwayland/4.19-thud/environment-setup-aarch64-poky-linux // <2>
$ ${CXX} -Wall -Wextra -O3 -std=c++14 caffe_inference.cpp -o caffe_inference -larmnn -larmnnCaffeParser // <3>
$ ${CXX} -Wall -Wextra -O3 -std=c++14 tensorflow_inference.cpp -o tensorflow_inference -larmnn -larmnnTfParser // <4>
----
<1> entering the `mnist` folder where is located the application.
<2> exporting the toolchain.
<3> compiling the caffe example source code.
<4> compiling the tensorflow example source code.
+
. Deploy the built files to the board:
+
_On Host GNU/Linux PC Terminal execute the following commands:_
+
[%autofit]
+
----
$ scp -r caffe_inference tensorflow_inference data/ model/ root@${IMX_INET_ADDR}:/opt/mnist // <1>
----
<1> copy the files to the board thru network.
+
. The folder structure must be equal to:
+
_On i.MX Board Minicom Terminal execute the following commands:_
+
[%autofit]
----
├── caffe_inference // <1>
├── tensorflow_inference // <2>
├── data // <3>
│   ├── t10k-images-idx3-ubyte // <4>
│   └── t10k-labels-idx1-ubyte // <5>
└── model // <6>
    ├── lenet_iter_9000.caffemodel // <7>
    ├── optimized_mnist_tf.pb // <8>
    ├── simple_mnist_tf.pb // <9>
    └── simple_mnist_tf.prototxt // <10>
----
<1> caffe binary.
<2> tensorflow binary.
<3> folder to hold the dataset.
<4> images dataset.
<5> label dataset.
<6> folder to hold the models
<7> caffe model.
<8> optimized tensorflow model.
<9> tensorflow model.
<10> protocol buffer.


[TIP]
====
The input images are in the binary form and can be found at the
http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz[t10k-images-idx3-ubyte.gz]
package from {MNIST}[Yann Lecun].
====

<<<

[[run_mnist]]
=== Running the MNIST Applications (inst)

These tests run inference on MNIST dataset (`Actual`) and outputs the inference
results (`Predict`).

. **Run the applications**:
+
Enter as an argument the number of predictions (`0` to `9999`) to be inferenced.
+
.. The `caffe_inference` uses a `Caffe` model for inference:
+
_On i.MX Board Minicom Terminal execute the following commands:_
+
[%autofit]
----
root@imx8mmevk:/opt/mnist# ./caffe_inference 10 // <1>
[0]     Caffe >> Actual: 7  Predict: 7  Time: 0.0336484s
[1]     Caffe >> Actual: 2  Predict: 2  Time: 0.028399s
[2]     Caffe >> Actual: 1  Predict: 1  Time: 0.0283713s
[3]     Caffe >> Actual: 0  Predict: 0  Time: 0.0284133s
[4]     Caffe >> Actual: 4  Predict: 4  Time: 0.0280637s
[5]     Caffe >> Actual: 1  Predict: 1  Time: 0.0281574s
[6]     Caffe >> Actual: 4  Predict: 4  Time: 0.0285136s
[7]     Caffe >> Actual: 9  Predict: 9  Time: 0.0283779s
[8]     Caffe >> Actual: 5  Predict: 5  Time: 0.0283902s
[9]     Caffe >> Actual: 9  Predict: 9  Time: 0.0283282s
Total Time: 0.296081s   Successfull: 10  Failed: 0
----
<1> running the application passing 10 test examples.
+
.. The `tensorflow_inference` uses a `TensorFlow` model for inference:
+
_On i.MX Board Minicom Terminal execute the following commands:_
+
[%autofit]
----
root@imx8mmevk:/opt/mnist# ./tensorflow_inference 10 // <1>
[0]     Tensor >> Actual: 7  Predict: 7  Time: 0.00670075s
[1]     Tensor >> Actual: 2  Predict: 2  Time: 0.00377025s
[2]     Tensor >> Actual: 1  Predict: 1  Time: 0.0036785s
[3]     Tensor >> Actual: 0  Predict: 0  Time: 0.0036815s
[4]     Tensor >> Actual: 4  Predict: 4  Time: 0.00372875s
[5]     Tensor >> Actual: 1  Predict: 1  Time: 0.003669s
[6]     Tensor >> Actual: 4  Predict: 4  Time: 0.00367825s
[7]     Tensor >> Actual: 9  Predict: 9  Time: 0.0036955s
[8]     Tensor >> Actual: 5  Predict: 6  Time: 0.00367488s      FAILED
[9]     Tensor >> Actual: 9  Predict: 9  Time: 0.0036025s
Total Time: 0.0414569s  Successfull: 10  Failed: 1
----
<1> running the application passing 10 test examples.
+

Notice that `Caffe` model is slower than `TensorFlow`, however more accurate than the latter. 

[TIP]
====
**Change the argument to compare further results between models**.
====

<<<
